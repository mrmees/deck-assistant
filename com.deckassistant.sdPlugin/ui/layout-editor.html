<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Deck Assistant - Style Editor</title>
    <script defer src="js/alpine.min.js"></script>
    <link rel="stylesheet" href="css/layout-editor.css">
</head>
<body>
    <div x-data="styleEditor()" x-init="init()">
        <!-- Header -->
        <header class="header">
            <h1>Deck Assistant - Style Editor</h1>
            <div class="device-info">
                <button class="btn btn-secondary btn-small"
                        @click="startWizard()"
                        x-show="!showWizard && wizardComplete"
                        style="margin-right: 12px;">
                    Reconfigure
                </button>
                <select class="filter-select" x-model="selectedDeviceId" @change="updateDeviceSize()" style="margin-right: 8px;">
                    <template x-for="device in availableDevices" :key="device.id">
                        <option :value="device.id" x-text="device.name + ' (' + device.cols + 'x' + device.rows + ')'"></option>
                    </template>
                </select>
                <span class="connection-status" :class="connected ? 'connected' : 'disconnected'"></span>
            </div>
        </header>

        <!-- Loading State -->
        <template x-if="loading">
            <div class="loading">
                <div class="spinner"></div>
                <span x-text="status"></span>
                <div style="margin-top: 20px; font-size: 11px; color: #666;">
                    <div x-text="'Parent window: ' + (parentWindow ? 'found' : 'not found')"></div>
                    <div x-text="'Entities loaded: ' + allEntities.length"></div>
                </div>
            </div>
        </template>

        <!-- Style Editor (shown after wizard completes) -->
        <template x-if="!loading && connected && wizardComplete">
            <div class="style-editor">
                <!-- Left Panel - Group Styling -->
                <div class="style-panel-left">
                    <div class="panel-header">
                        <span>Group Styles</span>
                    </div>

                    <div class="style-groups-list">
                        <!-- Groups -->
                        <template x-for="(group, index) in wizardSelections.groups" :key="group.name">
                            <div class="style-group-item">
                                <div class="style-group-header" @click="toggleGroupExpanded(index)">
                                    <span class="style-group-expand" x-text="group.expanded ? '‚ñº' : '‚ñ∂'"></span>
                                    <span class="style-group-name" x-text="group.name"></span>
                                    <span class="style-group-count" x-text="group.entities.length"></span>
                                    <span class="style-group-type" x-text="group.displayType"></span>
                                </div>

                                <template x-if="group.expanded">
                                    <div class="style-group-content">
                                        <!-- Style Controls -->
                                        <div class="style-controls">
                                            <div class="style-control-row">
                                                <label>Background</label>
                                                <input type="color"
                                                       :value="getGroupStyle(group.name).backgroundColor"
                                                       @input="setGroupStyleProp(group.name, 'backgroundColor', $event.target.value)">
                                            </div>
                                            <div class="style-control-row">
                                                <label>Icon Color</label>
                                                <input type="color"
                                                       :value="getGroupStyle(group.name).iconColor"
                                                       @input="setGroupStyleProp(group.name, 'iconColor', $event.target.value)">
                                            </div>
                                            <div class="style-control-row">
                                                <label>Text Color</label>
                                                <input type="color"
                                                       :value="getGroupStyle(group.name).textColor"
                                                       @input="setGroupStyleProp(group.name, 'textColor', $event.target.value)">
                                            </div>
                                        </div>

                                        <!-- Entity List Preview -->
                                        <div class="style-group-entities">
                                            <template x-for="entityId in group.entities.slice(0, 5)" :key="entityId">
                                                <div class="style-entity-item" x-text="getEntityName(entityId)"></div>
                                            </template>
                                            <template x-if="group.entities.length > 5">
                                                <div class="style-entity-more" x-text="'+ ' + (group.entities.length - 5) + ' more'"></div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Ungrouped Entities with Sorting -->
                        <template x-if="wizardSelections.ungroupedEntities && wizardSelections.ungroupedEntities.length > 0">
                            <div class="ungrouped-section">
                                <div class="panel-header">
                                    <span>Ungrouped Items</span>
                                    <span class="item-count" x-text="wizardSelections.ungroupedEntities.length"></span>
                                </div>

                                <!-- Style Controls (collapsible) -->
                                <div class="style-group-item" style="margin: 8px;">
                                    <div class="style-group-header" @click="ungroupedExpanded = !ungroupedExpanded">
                                        <span class="style-group-expand" x-text="ungroupedExpanded ? '‚ñº' : '‚ñ∂'"></span>
                                        <span class="style-group-name">Style</span>
                                    </div>
                                    <template x-if="ungroupedExpanded">
                                        <div class="style-group-content">
                                            <div class="style-controls">
                                                <div class="style-control-row">
                                                    <label>Background</label>
                                                    <input type="color"
                                                           :value="ungroupedStyle.backgroundColor"
                                                           @input="ungroupedStyle.backgroundColor = $event.target.value">
                                                </div>
                                                <div class="style-control-row">
                                                    <label>Icon Color</label>
                                                    <input type="color"
                                                           :value="ungroupedStyle.iconColor"
                                                           @input="ungroupedStyle.iconColor = $event.target.value">
                                                </div>
                                                <div class="style-control-row">
                                                    <label>Text Color</label>
                                                    <input type="color"
                                                           :value="ungroupedStyle.textColor"
                                                           @input="ungroupedStyle.textColor = $event.target.value">
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- Sort Options -->
                                <div class="sort-options">
                                    <template x-for="option in getAvailableSortOptions()" :key="option.id">
                                        <button class="sort-btn"
                                                :class="{ 'active': wizardSelections.ungroupedSort === option.id }"
                                                @click="applyUngroupedSort(option.id)"
                                                x-text="option.label">
                                        </button>
                                    </template>
                                    <span class="sort-status" x-show="wizardSelections.ungroupedSort === 'custom'">
                                        (Custom order)
                                    </span>
                                </div>

                                <!-- Draggable List with Position Numbers and Page Indicators -->
                                <div class="ungrouped-list" id="ungrouped-sortable">
                                    <template x-for="(entityId, index) in wizardSelections.ungroupedEntities" :key="entityId">
                                        <div class="ungrouped-item"
                                             draggable="true"
                                             @dragstart="handleUngroupedDragStart($event, index)"
                                             @dragover.prevent="handleUngroupedDragOver($event, index)"
                                             @dragleave="handleUngroupedDragLeave()"
                                             @drop="handleUngroupedDrop($event, index)"
                                             :class="{
                                                 'drag-over': ungroupedDragOverIndex === index,
                                                 'page-break': index > 0 && getEntityPageNumber(index) !== getEntityPageNumber(index - 1)
                                             }">
                                            <span class="drag-handle">&#8942;&#8942;</span>
                                            <span class="ungrouped-position" x-text="index + 1"></span>
                                            <span class="ungrouped-item-name" x-text="getEntityById(entityId)?.friendly_name || entityId"></span>
                                            <span class="ungrouped-item-page" x-text="'P' + getEntityPageNumber(index)"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Center Panel - Stream Deck Preview -->
                <div class="style-panel-center">
                    <div class="preview-header">
                        <span class="preview-title" x-text="getCurrentPreviewPage()?.name || 'Preview'"></span>
                    </div>

                    <div class="preview-container">
                        <div class="preview-grid" :style="previewGridStyle">
                            <template x-for="(button, index) in getPreviewButtons()" :key="index">
                                <div class="preview-button"
                                     :style="getPreviewButtonStyle(button)"
                                     @click="handlePreviewNavigation(button)">
                                    <div class="preview-button-icon">
                                        <!-- SVG icon when loaded -->
                                        <svg x-show="button.icon && getIconPath(button.icon)"
                                             viewBox="0 0 24 24"
                                             class="mdi-icon">
                                            <path :d="getIconPath(button.icon)" :fill="button.iconColor"/>
                                        </svg>
                                        <!-- Loading indicator -->
                                        <span x-show="button.icon && !getIconPath(button.icon) && isIconLoading(button.icon)"
                                              class="icon-loading">...</span>
                                        <!-- Empty placeholder for empty buttons -->
                                        <span x-show="!button.icon"></span>
                                    </div>
                                    <div class="preview-button-label" :style="{ color: button.textColor }" x-text="button.label"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="preview-info">
                        <span x-text="getCurrentPreviewPage()?.name || 'No pages'"></span>
                        <span x-text="previewPages.length > 0 ? (currentPreviewPageIndex + 1) + ' / ' + previewPages.length : ''"></span>
                    </div>
                </div>

                <!-- Right Panel - Theme & Presets -->
                <div class="style-panel-right">
                    <div class="panel-header">
                        <span>Theme</span>
                    </div>

                    <div class="theme-content">
                        <!-- Presets -->
                        <div class="theme-section">
                            <div class="theme-section-title">Presets</div>
                            <div class="theme-presets">
                                <button class="theme-preset-btn"
                                        :class="{ active: currentPreset === 'dark' }"
                                        @click="applyPreset('dark')">
                                    Stream Deck Dark
                                </button>
                                <button class="theme-preset-btn"
                                        :class="{ active: currentPreset === 'blue' }"
                                        @click="applyPreset('blue')">
                                    Home Assistant Blue
                                </button>
                                <button class="theme-preset-btn"
                                        :class="{ active: currentPreset === 'minimal' }"
                                        @click="applyPreset('minimal')">
                                    Minimal White
                                </button>
                            </div>
                        </div>

                        <!-- Domain Colors -->
                        <div class="theme-section">
                            <div class="theme-section-title">Domain Colors</div>
                            <div class="theme-domain-colors">
                                <template x-for="(color, domain) in domainColors" :key="domain">
                                    <div class="theme-row">
                                        <span class="theme-label" x-text="formatDomainName(domain)"></span>
                                        <input type="color" class="color-picker" x-model="domainColors[domain]">
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Navigation Settings -->
                        <div class="theme-section">
                            <div class="theme-section-title">Navigation</div>

                            <div class="setting-row">
                                <label class="setting-label">Nav Buttons</label>
                                <select class="setting-select" x-model="theme.navStartPosition">
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="top-left">Top Left</option>
                                </select>
                            </div>

                            <div class="setting-row">
                                <label class="setting-label">Folder Up</label>
                                <select class="setting-select" x-model="theme.folderUpPosition">
                                    <option value="bottom-right">Bottom Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="top-left">Top Left</option>
                                </select>
                            </div>
                        </div>

                        <!-- Home Assistant Labels -->
                        <div class="theme-section" x-show="wizardSelections.groups && wizardSelections.groups.length > 0">
                            <div class="theme-section-title">Home Assistant</div>
                            <div class="ha-labels-section">
                                <p class="ha-labels-description">
                                    Add deck-assistant labels to entities in Home Assistant. Makes future configurations easier.
                                </p>
                                <button class="btn btn-secondary btn-block"
                                        @click="addLabelsToHomeAssistant()"
                                        :disabled="labelSyncStatus === 'syncing'">
                                    <span x-show="!labelSyncStatus">Add Labels to HA</span>
                                    <span x-show="labelSyncStatus === 'syncing'">Adding...</span>
                                    <span x-show="labelSyncStatus === 'synced'">Done!</span>
                                    <span x-show="labelSyncStatus === 'error'">Error</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Welcome State (before wizard runs) -->
        <template x-if="!loading && connected && !wizardComplete && !showWizard">
            <div class="welcome-state">
                <div class="welcome-content">
                    <h2>Welcome to Deck Assistant</h2>
                    <p>Configure your Stream Deck with Home Assistant entities.</p>
                    <button class="btn btn-primary btn-large" @click="startWizard()">
                        Start Setup Wizard
                    </button>
                </div>
            </div>
        </template>

        <!-- Footer -->
        <template x-if="!loading && connected && wizardComplete">
            <footer class="footer">
                <button class="btn btn-secondary" @click="startWizard()">
                    Reconfigure
                </button>
                <button class="btn btn-primary" @click="showProfileNameModal = true">
                    Generate Profile
                </button>
            </footer>
        </template>

        <!-- Profile Name Modal -->
        <template x-if="showProfileNameModal">
            <div class="modal-overlay" @click.self="showProfileNameModal = false">
                <div class="modal">
                    <div class="modal-title">Name Your Profile</div>
                    <input type="text"
                           class="modal-input"
                           placeholder="e.g., Home Assistant"
                           x-model="profileName"
                           @keyup.enter="generateProfile()">
                    <div class="modal-actions">
                        <button class="btn btn-secondary" @click="showProfileNameModal = false">Cancel</button>
                        <button class="btn btn-primary" @click="generateProfile()" :disabled="!profileName.trim()">Generate</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Generated Profile Modal -->
        <template x-if="showGeneratedProfileModal && generatedProfile">
            <div class="modal-overlay" @click.self="showGeneratedProfileModal = false">
                <div class="modal" style="width: 500px;">
                    <div class="modal-title">Profile Generated!</div>
                    <template x-if="generatedProfile.filePath">
                        <div>
                            <div style="margin-bottom: 16px; padding: 12px; background: #1a3d1a; border-radius: 6px; color: #8f8;">
                                ‚úì Saved to Downloads folder
                            </div>
                            <div style="margin-bottom: 16px; padding: 12px; background: #2a2a2a; border-radius: 6px; font-family: monospace; font-size: 11px; word-break: break-all;">
                                <span x-text="generatedProfile.filePath"></span>
                            </div>
                        </div>
                    </template>
                    <template x-if="!generatedProfile.filePath">
                        <div style="margin-bottom: 16px; padding: 12px; background: #3d1a1a; border-radius: 6px; color: #f88;">
                            ‚úó Could not save file. Check Downloads folder permissions.
                        </div>
                    </template>
                    <div style="margin-bottom: 16px; font-size: 13px; color: #ccc;">
                        To import: Double-click the <strong>.streamDeckProfile</strong> file in your Downloads folder.
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" @click="showGeneratedProfileModal = false">Done</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Wizard Overlay -->
        <template x-if="showWizard">
            <div class="wizard-overlay">
                <div class="wizard">
                    <div class="wizard-step">
                        <!-- Progress Indicator -->
                        <div class="wizard-progress-container">
                            <!-- Main Path Progress -->
                            <div class="wizard-progress">
                                <template x-for="(step, index) in getMainWizardPath()" :key="step.id">
                                    <div class="wizard-progress-step"
                                         :class="{
                                             active: getMainWizardProgress() === index,
                                             completed: getMainWizardProgress() > index,
                                             'is-loop': step.isLoop
                                         }">
                                        <div class="wizard-dot"></div>
                                        <span class="wizard-step-label" x-text="step.label"></span>
                                    </div>
                                </template>
                            </div>

                            <!-- Group Creation Sub-progress (shown during group loop) -->
                            <template x-if="isInGroupCreationLoop()">
                                <div class="wizard-subprogress">
                                    <div class="subprogress-label">
                                        <span class="loop-indicator">‚Üª</span>
                                        Creating Group <span x-text="getGroupCreationProgress()?.groupNumber"></span>
                                        <span class="subprogress-steps">
                                            (Step <span x-text="getGroupCreationProgress()?.current"></span>/<span x-text="getGroupCreationProgress()?.total"></span>)
                                        </span>
                                    </div>
                                    <div class="subprogress-hint">
                                        You'll return to group management after this
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="wizard-title" x-text="wizardSteps[wizardStep].title"></div>
                        <div class="wizard-subtitle" x-text="wizardSteps[wizardStep].subtitle"></div>

                        <!-- Welcome Step -->
                        <template x-if="wizardSteps[wizardStep].id === 'welcome'">
                            <div class="wizard-welcome">
                                <div class="wizard-tip-note">
                                    <strong>Tip:</strong> You can simplify this process by adding a <code>deck-assistant</code> label to entities in Home Assistant before starting. The wizard will let you filter to only those labeled entities.
                                </div>

                                <div class="wizard-important-note">
                                    <strong>Important:</strong> Due to Stream Deck SDK limitations, this plugin generates profile files that you must import manually. Once imported, Deck Assistant cannot modify your Stream Deck layout directly.
                                </div>

                                <p class="wizard-section-header">How it works:</p>
                                <ol class="wizard-steps-list">
                                    <li><strong>Configure</strong> ‚Äî Select your Home Assistant entities and organize them into groups</li>
                                    <li><strong>Generate</strong> ‚Äî Create a .streamDeckProfile file</li>
                                    <li><strong>Import</strong> ‚Äî Double-click the file to add it to Stream Deck</li>
                                    <li><strong>Control</strong> ‚Äî Buttons will communicate with Home Assistant in real-time</li>
                                </ol>

                                <p class="wizard-section-header">This wizard will help you:</p>
                                <ul>
                                    <li>Select which areas/rooms to control</li>
                                    <li>Choose device types (lights, switches, climate, etc.)</li>
                                    <li>Pick specific entities</li>
                                    <li>Organize them by room or device type</li>
                                </ul>

                            </div>
                        </template>

                        <!-- Choice Steps (approach, group-type, layout, etc.) -->
                        <template x-if="wizardSteps[wizardStep].type === 'choice' && wizardSteps[wizardStep].id !== 'group-complete'">
                            <div class="wizard-choice-select">
                                <!-- Search box for steps with many options -->
                                <template x-if="getWizardOptions().length > 4">
                                    <div class="wizard-filters">
                                        <div class="wizard-search">
                                            <input type="text"
                                                   class="wizard-search-input"
                                                   placeholder="Search options..."
                                                   x-model="wizardEntitySearch">
                                            <span class="wizard-search-icon">üîç</span>
                                        </div>
                                    </div>
                                </template>
                                <div class="wizard-options wizard-scrollable">
                                    <template x-for="option in filterWizardOptions(getWizardOptions())" :key="option.id">
                                        <div class="wizard-option wizard-option-large"
                                             :class="{ selected: isWizardOptionSelected(option.id) }"
                                             @click="toggleWizardOption(option.id)">
                                            <input type="radio" :checked="isWizardOptionSelected(option.id)">
                                            <div class="wizard-option-content">
                                                <span class="wizard-option-name" x-text="option.name"></span>
                                                <span class="wizard-option-description" x-text="option.description"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="filterWizardOptions(getWizardOptions()).length === 0">
                                        <div class="wizard-no-results">
                                            No options match your search
                                        </div>
                                    </template>
                                </div>
                                <!-- Stats for choice steps with search -->
                                <template x-if="getWizardOptions().length > 4">
                                    <div class="wizard-selection-stats">
                                        <div class="wizard-stat">
                                            <span class="wizard-stat-value" x-text="getWizardOptions().length"></span>
                                            <span class="wizard-stat-label">Total</span>
                                        </div>
                                        <div class="wizard-stat">
                                            <span class="wizard-stat-value" x-text="filterWizardOptions(getWizardOptions()).length"></span>
                                            <span class="wizard-stat-label">Filtered</span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Group Complete Step (special buttons) -->
                        <template x-if="wizardSteps[wizardStep].id === 'group-complete'">
                            <div class="wizard-group-complete">
                                <div class="wizard-group-summary">
                                    <p>You've created <strong x-text="wizardSelections.groups.length"></strong> group(s):</p>
                                    <ul class="wizard-groups-list">
                                        <template x-for="group in wizardSelections.groups" :key="group.name">
                                            <li>
                                                <strong x-text="group.name"></strong>
                                                <span x-text="'(' + group.entities.length + ' entities)'"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                                <div class="wizard-group-actions">
                                    <button class="btn btn-secondary btn-block" @click="handleGroupCompleteChoice('another')">
                                        + Add Another Group
                                    </button>
                                    <button class="btn btn-secondary btn-block" @click="handleGroupCompleteChoice('ungrouped')">
                                        + Add Ungrouped Entities
                                    </button>
                                    <button class="btn btn-primary btn-block" @click="handleGroupCompleteChoice('done')">
                                        Done ‚Äî Configure Layout
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Group Layout Configuration Step -->
                        <template x-if="wizardSteps[wizardStep].id === 'group-layout'">
                            <div class="wizard-group-layout">
                                <div class="wizard-group-config-header">
                                    <p class="wizard-group-layout-intro">Choose how each group renders. Order below reflects render priority.</p>
                                    <div class="wizard-display-options-summary">
                                        <span><strong>Folder</strong> ‚Äî Button on main page; entities on separate sub-page</span>
                                        <span><strong>Flat</strong> ‚Äî Entities render directly on main page after folders</span>
                                        <span><strong>Page</strong> ‚Äî Entities on separate page(s) at end of navigation</span>
                                    </div>
                                    <p class="wizard-group-layout-hint">Drag groups to reorder render priority within each type.</p>
                                </div>

                                <div class="wizard-group-config-list">
                                    <template x-for="(group, index) in wizardSelections.groups" :key="group.name">
                                        <div class="wizard-group-config-item"
                                             draggable="true"
                                             :class="{ 'drag-over': groupDragOverIndex === index }"
                                             @dragstart="handleGroupDragStart($event, index)"
                                             @dragend="handleGroupDragEnd()"
                                             @dragover.prevent="handleGroupDragOver($event, index)"
                                             @dragleave="handleGroupDragLeave()"
                                             @drop="handleGroupDrop($event, index)">
                                            <div class="wizard-group-drag-handle">‚ãÆ‚ãÆ</div>
                                            <div class="wizard-group-config-info">
                                                <span class="wizard-group-config-name" x-text="group.name"></span>
                                                <span class="wizard-group-config-count" x-text="group.entities.length + ' entities'"></span>
                                            </div>
                                            <div class="wizard-group-config-options">
                                                <button class="wizard-display-btn"
                                                        :class="{ active: group.displayType === 'folder' }"
                                                        @click="setGroupDisplayType(index, 'folder')">
                                                    Folder
                                                </button>
                                                <button class="wizard-display-btn"
                                                        :class="{ active: group.displayType === 'flat' }"
                                                        @click="setGroupDisplayType(index, 'flat')">
                                                    Flat
                                                </button>
                                                <button class="wizard-display-btn"
                                                        :class="{ active: group.displayType === 'page' }"
                                                        @click="setGroupDisplayType(index, 'page')">
                                                    Page
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Multi-select Steps (group-entities, simple-entities) -->
                        <template x-if="wizardSteps[wizardStep].type === 'multiselect'">
                            <div class="wizard-entity-select">
                                <!-- Search and filter for entity steps -->
                                <div class="wizard-filters">
                                    <div class="wizard-search">
                                        <input type="text"
                                               class="wizard-search-input"
                                               placeholder="Search by name, area, or device type..."
                                               x-model="wizardEntitySearch">
                                        <span class="wizard-search-icon">üîç</span>
                                    </div>
                                    <div class="wizard-filter-row">
                                        <label class="wizard-filter-checkbox" x-show="entitiesWithLabels.length > 0">
                                            <input type="checkbox" x-model="wizardShowLinkedOnly">
                                            <span>Deck Assistant labeled only</span>
                                        </label>
                                        <label class="wizard-filter-checkbox">
                                            <input type="checkbox" x-model="wizardHideUnavailable">
                                            <span>Hide disabled/unavailable</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="wizard-options wizard-scrollable">
                                    <template x-for="option in getWizardOptions()" :key="option.id">
                                        <div class="wizard-option"
                                             :class="{ selected: isWizardOptionSelected(option.id) }"
                                             @click="toggleWizardOption(option.id)">
                                            <input type="checkbox" :checked="isWizardOptionSelected(option.id)">
                                            <div class="wizard-option-content">
                                                <span class="wizard-option-name" x-text="option.name"></span>
                                                <span class="wizard-option-subtitle" x-text="option.subtitle" x-show="option.subtitle"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="getWizardOptions().length === 0">
                                        <div class="wizard-no-results">
                                            No entities match your search
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Group Name Input Step -->
                        <template x-if="wizardSteps[wizardStep].id === 'group-name'">
                            <div class="wizard-input-step">
                                <input type="text"
                                       class="wizard-text-input"
                                       placeholder="e.g., Living Room, All Lights, Favorites..."
                                       x-model="wizardSelections.currentGroupName"
                                       @keyup.enter="wizardNext()">
                                <p class="wizard-note">This name will appear as a folder or page on your Stream Deck.</p>
                            </div>
                        </template>

                        <!-- Confirm Step -->
                        <template x-if="wizardSteps[wizardStep].id === 'confirm'">
                            <div class="wizard-confirm">
                                <div class="wizard-summary">
                                    <div class="wizard-summary-item">
                                        <span class="wizard-summary-label">Approach:</span>
                                        <span class="wizard-summary-value" x-text="wizardSelections.approach === 'groups' ? 'Custom Groups' : 'Quick Setup'"></span>
                                    </div>
                                    <div class="wizard-summary-item">
                                        <span class="wizard-summary-label">Groups:</span>
                                        <span class="wizard-summary-value" x-text="wizardSelections.approach === 'groups' ? wizardSelections.groups.length : 'Auto by Area'"></span>
                                    </div>
                                    <div class="wizard-summary-item">
                                        <span class="wizard-summary-label">Total Entities:</span>
                                        <span class="wizard-summary-value" x-text="wizardSelections.approach === 'groups' ? wizardSelections.groups.reduce((sum, g) => sum + g.entities.length, 0) : wizardSelections.simpleEntities.length"></span>
                                    </div>
                                    <div class="wizard-summary-item">
                                        <span class="wizard-summary-label">Layout:</span>
                                        <span class="wizard-summary-value" x-text="wizardSelections.layoutStyle === 'groups-as-folders' ? 'Folders' : wizardSelections.layoutStyle === 'groups-as-pages' ? 'Pages' : 'Flat'"></span>
                                    </div>
                                </div>
                                <p class="wizard-note">Click "Generate Profile" to create your Stream Deck profile file.</p>
                            </div>
                        </template>

                        <!-- Selection count for multi-select steps -->
                        <template x-if="wizardSteps[wizardStep].type === 'multiselect'">
                            <div class="wizard-selection-stats">
                                <div class="wizard-stat">
                                    <span class="wizard-stat-value" x-text="wizardSteps[wizardStep].id === 'group-entities' ? wizardSelections.currentGroupEntities.length : (wizardSteps[wizardStep].id === 'ungrouped-entities' ? wizardSelections.ungroupedEntities.length : wizardSelections.simpleEntities.length)"></span>
                                    <span class="wizard-stat-label">Selected</span>
                                </div>
                                <div class="wizard-stat">
                                    <span class="wizard-stat-value" x-text="getWizardTotalCount()"></span>
                                    <span class="wizard-stat-label">Total</span>
                                </div>
                                <div class="wizard-stat">
                                    <span class="wizard-stat-value" x-text="getWizardOptions().length"></span>
                                    <span class="wizard-stat-label">Filtered</span>
                                </div>
                            </div>
                        </template>

                        <!-- Standard wizard actions (hidden on group-complete which has its own buttons) -->
                        <template x-if="wizardSteps[wizardStep].id !== 'group-complete'">
                            <div class="wizard-actions">
                                <button class="btn btn-secondary" @click="wizardBack()">
                                    <span x-text="wizardStep === 0 ? 'Cancel' : 'Back'"></span>
                                </button>
                                <button class="btn btn-primary" @click="wizardNext()">
                                    <span x-text="wizardSteps[wizardStep].id === 'confirm' ? 'Generate Profile' : wizardSteps[wizardStep].id === 'group-name' ? 'Create Group' : 'Next'"></span>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script src="js/layout-editor.js"></script>
</body>
</html>
